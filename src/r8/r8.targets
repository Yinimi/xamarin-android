<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask AssemblyFile="..\..\bin\Build$(Configuration)\xa-prep-tasks.dll" TaskName="Xamarin.Android.BuildTools.PrepTasks.DownloadUri" />
  <UsingTask AssemblyFile="..\..\bin\Build$(Configuration)\Xamarin.Android.Tools.BootstrapTasks.dll" TaskName="Xamarin.Android.Tools.BootstrapTasks.UnzipDirectoryChildren" />

  <PropertyGroup>
    <!--NOTE: we don't want a gradle daemon locking directories on Windows-->
    <_GradleArgs>--stacktrace --no-daemon</_GradleArgs>
    <_GradleEnv Condition=" '$(JavaSdkDirectory)' != '' ">JAVA_HOME=$(JavaSdkDirectory)</_GradleEnv>
    <BuildDependsOn>
      ResolveReferences;
      _BuildR8;
      _CopyR8;
    </BuildDependsOn>
    <CleanDependsOn>
      _CleanR8;
    </CleanDependsOn>
  </PropertyGroup>
  <Target Name="Build" DependsOnTargets="$(BuildDependsOn)" />
  <Target Name="Clean" DependsOnTargets="$(CleanDependsOn)" />

  <!--
    NOTE: depot_tools has an odd requirement of being in PATH
  -->

  <Target Name="_BuildR8">
    <Exec
      Command="python tools\gradle.py d8 r8 $(_GradleArgs)"
      WorkingDirectory="..\..\external\r8"
      EnvironmentVariables="$(_GradleEnv)"
    />
  </Target>

  <Target Name="_CopyR8">
    <Copy
        SourceFiles="..\..\external\r8\build\libs\d8.jar;..\..\external\r8\build\libs\r8.jar"
        DestinationFolder="$(XAInstallPrefix)xbuild\Xamarin\Android\"
        SkipUnchangedFiles="true"
    />
  </Target>

  <Target Name="_CleanR8">
    <Delete
        Files="$(XAInstallPrefix)xbuild\Xamarin\Android\d8.jar;$(XAInstallPrefix)xbuild\Xamarin\Android\r8.jar;"
    />
    <Exec
      Command="python tools\gradle.py clean $(_GradleArgs)"
      WorkingDirectory="..\..\external\r8"
      EnvironmentVariables="$(_GradleEnv)"
    />
  </Target>

</Project>
